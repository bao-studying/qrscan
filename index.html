<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üáªüá≥ VietQR Pro Payment</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
      :root {
        --primary: #0056b3;
        --success: #28a745;
        --bg: #f2f4f7;
        --card-bg: #ffffff;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        color: #333;
      }
      h1 { color: var(--primary); margin-bottom: 15px; font-size: 1.4rem; }
      
      /* Camera Frame */
      #reader {
        width: 100%;
        max-width: 420px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        background: #000;
        margin-bottom: 20px;
        display: none; 
      }

      /* Container chung */
      .card {
        width: 100%;
        max-width: 420px;
        background: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        box-sizing: border-box;
        margin-bottom: 20px;
      }

      /* 1. Modal Nh·∫≠p t√™n */
      #setup-modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(4px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        width: 85%;
        max-width: 320px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      }
      .custom-input {
        width: 100%;
        padding: 14px;
        margin: 15px 0;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 1rem;
        box-sizing: border-box;
        text-align: center;
        background: #f9f9f9;
      }

      /* 2. Form Chuy·ªÉn kho·∫£n */
      #result-card { display: none; }
      
      .block {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        border: 1px solid #edf0f2;
      }
      .block-title {
        font-size: 0.75rem;
        color: #888;
        margin-bottom: 10px;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.95rem;
        line-height: 1.4;
      }
      .info-label { color: #666; }
      .info-val { font-weight: 600; color: #222; text-align: right; word-break: break-all; flex: 1; margin-left: 10px;}
      .highlight { color: var(--primary); }

      .money-input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary);
        border-bottom: 2px solid #e0e0e0;
        padding: 8px 0;
        outline: none;
        text-align: center;
      }
      .money-input:focus { border-bottom-color: var(--primary); }

      .content-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-family: inherit;
        box-sizing: border-box;
        resize: none;
      }

      .btn-primary {
        width: 100%;
        padding: 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s, background 0.2s;
        box-shadow: 0 4px 10px rgba(0,86,179,0.2);
      }
      .btn-primary:active { transform: scale(0.98); background: #004494; }

      /* 3. Ticket Th√†nh c√¥ng (C·∫≠p nh·∫≠t UI/UX) */
      #ticket-card {
        display: none;
        background: #fff;
        padding: 0;
        overflow: hidden;
        position: relative;
        background-image: radial-gradient(circle at 0 0, transparent 0, transparent 0), radial-gradient(circle at 100% 0, transparent 0, transparent 0);
      }
      
      .ticket-header-ss {
        background: var(--success);
        color: white;
        padding: 30px 20px 40px;
        text-align: center;
        border-radius: 16px 16px 0 0; /* Bo g√≥c tr√™n */
      }
      .success-icon-circle {
        width: 50px; height: 50px;
        background: white;
        color: var(--success);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 24px;
        font-weight: bold;
      }

      .ticket-body {
        padding: 20px;
        position: relative;
        top: -20px;
        background: white;
        margin: 0 15px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      }

      .ticket-amount {
        text-align: center;
        font-size: 1.8rem;
        font-weight: 800;
        color: #333;
        margin-bottom: 5px;
      }
      
      .ticket-status-text {
        text-align: center;
        color: var(--success);
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 20px;
      }

      /* Header Bi√™n lai + Share */
      .receipt-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #eee;
      }
      .receipt-title {
        font-weight: 700;
        font-size: 1rem;
        color: #444;
      }
      .btn-share {
        background: #f0f2f5;
        border: 1px solid #dcdcdc;
        color: #555;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn-share:hover { background: #e9ecef; }

      .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 0.9rem;
      }
      .d-label { color: #888; }
      .d-val { font-weight: 600; color: #333; text-align: right; max-width: 60%; }

      .divider {
        border-top: 1px dashed #ddd;
        margin: 15px 0;
      }
      
      .message-box {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #555;
        margin-top: 5px;
        word-break: break-word;
      }

      /* Loading Overlay */
      #loading-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .spinner {
        width: 40px; height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-bottom: 15px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      .status { margin-top: 10px; font-style: italic; color: #666; text-align: center;}
    </style>
  </head>
  <body>
    <h1>üáªüá≥ VietQR Pay</h1>
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-weight:600; color:#555;">ƒêang x·ª≠ l√Ω...</div>
    </div>

    <div id="setup-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary)">Thi·∫øt l·∫≠p th√¥ng tin</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:5px;">Nh·∫≠p t√™n ch·ªß t√†i kho·∫£n (Ng∆∞·ªùi chuy·ªÉn):</p>
            <input type="text" id="sender-name-input" class="custom-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" autocomplete="off">
            <button class="btn-primary" onclick="confirmSetup()">X√°c nh·∫≠n & Qu√©t QR</button>
        </div>
    </div>

    <div id="reader"></div>
    <div class="status" id="status-text" style="display:none;">ƒêang b·∫≠t camera...</div>

    <div id="result-card" class="card">
      <h3 style="margin-top:0; text-align:center; color: var(--primary); margin-bottom: 20px;">Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
      
      <div class="block">
          <div class="block-title">ƒê·∫æN T√ÄI KHO·∫¢N</div>
          <div class="info-row">
              <span class="info-label">Ng√¢n h√†ng:</span>
              <span class="info-val" id="res-bank">...</span>
          </div>
          <div class="info-row">
              <span class="info-label">S·ªë t√†i kho·∫£n:</span>
              <span class="info-val highlight" id="res-acc">...</span>
          </div>
          <div class="info-row">
              <span class="info-label">Ch·ªß t√†i kho·∫£n:</span>
                 <span class="d-val" id="ticket-sender">...</span>
          </div>
      </div>

      <div class="block">
          <div class="block-title">S·ªê TI·ªÄN</div>
          <input type="number" id="input-amount" class="money-input" placeholder="0" oninput="formatMoneyDisplay()">
          <div style="text-align:center; font-size:0.8rem; color:#999; margin-top:5px;" id="money-text">0 VND</div>
      </div>

      <div class="block">
          <div class="block-title">N·ªòI DUNG</div>
          <textarea id="input-content" class="content-input" rows="2" placeholder="Nh·∫≠p n·ªôi dung chuy·ªÉn ti·ªÅn..."></textarea>
      </div>
      
      <button class="btn-primary" onclick="handleTransfer()">X√°c nh·∫≠n chuy·ªÉn kho·∫£n</button>
      <div style="text-align:center; margin-top:15px;">
        <a href="#" onclick="resetScanner()" style="color:#666; font-size:0.9rem; text-decoration:none;">H·ªßy giao d·ªãch</a>
      </div>
    </div>

    <div id="ticket-card" class="card">
        <div class="ticket-header-ss">
            <div class="success-icon-circle">‚úì</div>
            <div style="font-weight:600; font-size:1.1rem;">Chuy·ªÉn kho·∫£n th√†nh c√¥ng</div>
            <div style="font-size:0.85rem; opacity:0.9; margin-top:5px;" id="ticket-time">...</div>
        </div>

        <div class="ticket-body">
            <div class="ticket-amount" id="ticket-amount">0 VND</div>
            <div class="ticket-status-text">Giao d·ªãch ho√†n t·∫•t</div>

            <div class="receipt-header-row">
                <div class="receipt-title">Bi√™n lai chuy·ªÉn ti·ªÅn</div>
                <button class="btn-share" onclick="shareTicket()">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                    Chia s·∫ª
                </button>
            </div>

            <div class="detail-row">
                <span class="d-label">M√£ giao d·ªãch</span>
                <span class="d-val" id="ticket-trans-id" style="font-family:monospace; color:#555;">...</span>
            </div>

          

            <div class="divider"></div>

            <div class="detail-row">
                <span class="d-label">Ng∆∞·ªùi chuy·ªÉn</span>
                <span class="d-val" id="ticket-sender">...</span>
            </div>
            <div class="detail-row">
                <span class="d-label">Ng√¢n h√†ng</span>
                <span class="d-val" id="ticket-bank">...</span>
            </div>
            <div class="detail-row">
                <span class="d-label">S·ªë t√†i kho·∫£n</span>
                <span class="d-val" id="ticket-acc">...</span>
            </div>

            <div class="divider"></div>
            
            <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">N·ªôi dung chuy·ªÉn ti·ªÅn</div>
            <div class="message-box" id="ticket-content">...</div>

            <button class="btn-primary" style="margin-top:20px; background:#6c757d;" onclick="resetScanner()">Giao d·ªãch m·ªõi</button>
        </div>
    </div>

    <script>
      // üè¶ DATABASE BIN
      const BANK_BIN = {
        "970436": "Vietcombank", "970415": "VietinBank", "970418": "BIDV", "970405": "Agribank",
        "970448": "OCB", "970422": "MB Bank", "970407": "Techcombank", "970416": "ACB",
        "970432": "VPBank", "970423": "TPBank", "970403": "Sacombank", "970437": "HDBank",
        "970454": "VietCapital", "970429": "SCB", "970441": "VIB", "970443": "SHB",
        "970409": "Bac A Bank", "970412": "PVcomBank", "970430": "PGBank", "970428": "Nam A Bank",
        "970414": "OceanBank", "970449": "LienVietPostBank", "970425": "ABBank", "970400": "SaigonBank",
        "970452": "KienLongBank", "970446": "Co-op Bank", "970458": "UOB", "970410": "Standard Chartered",
        "970424": "Shinhan Bank", "970431": "Eximbank", "970438": "BaoViet Bank", "970440": "SeABank",
        "970427": "VietABank", "970419": "NCB", "970433": "VietBank", "970457": "Woori Bank"
      };

      let html5QrcodeScanner = null;
      let senderName = "Kh√°ch h√†ng"; // M·∫∑c ƒë·ªãnh n·∫øu kh√¥ng nh·∫≠p

      // --- LOGIC X·ª¨ L√ù ---

      // 1. Ph√¢n t√≠ch QR (TLV)
      function parseTLV(str) {
        const result = {};
        let i = 0;
        while (i < str.length) {
          const id = str.substr(i, 2);
          const len = parseInt(str.substr(i + 2, 2));
          const val = str.substr(i + 4, len);
          result[id] = val;
          i += 4 + len;
        }
        return result;
      }

      function processVietQR(qrContent) {
        try {
          const root = parseTLV(qrContent);
          if (!root["38"]) return null;
          const tag38Data = parseTLV(root["38"]);
          if (tag38Data["00"] !== "A000000727") return null;
          const serviceData = parseTLV(tag38Data["01"]);
          
          return {
            bankName: BANK_BIN[serviceData["00"]] || `Ng√¢n h√†ng l·∫° (${serviceData["00"]})`,
            accountNo: serviceData["01"],
            amount: root["54"] || "",
            content: root["62"] ? parseTLV(root["62"])["08"] : "",
            accName: root["59"] || "Kh√¥ng x√°c ƒë·ªãnh"
          };
        } catch (e) {
          return null;
        }
      }

      // 2. Setup ban ƒë·∫ßu
      function confirmSetup() {
        const inputName = document.getElementById("sender-name-input").value;
        if(inputName.trim() !== "") {
            senderName = inputName.toUpperCase(); // L∆∞u t√™n ng∆∞·ªùi chuy·ªÉn
        }
        document.getElementById("setup-modal").style.display = "none";
        document.getElementById("reader").style.display = "block";
        document.getElementById("status-text").style.display = "block";
        startCamera();
      }

      // 3. Loading
      function showLoading(text, duration, callback) {
          const overlay = document.getElementById("loading-overlay");
          document.getElementById("loading-text").innerText = text;
          overlay.style.display = "flex";
          setTimeout(() => {
              overlay.style.display = "none";
              if(callback) callback();
          }, duration);
      }

      // 4. Qu√©t xong
      function onScanSuccess(decodedText) {
        const qrInfo = processVietQR(decodedText);
        if (qrInfo) {
          if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById("reader").style.display = "none";
                document.getElementById("status-text").style.display = "none";
            });
          }

          showLoading("ƒêang truy xu·∫•t th√¥ng tin...", 2000, () => {
              document.getElementById("res-bank").textContent = qrInfo.bankName;
              document.getElementById("res-acc").textContent = qrInfo.accountNo;
              document.getElementById("res-name").textContent = qrInfo.accName;
              document.getElementById("input-amount").value = qrInfo.amount;
              document.getElementById("input-content").value = qrInfo.content;
              formatMoneyDisplay();
              document.getElementById("result-card").style.display = "block";
          });
        } else {
           alert("M√£ QR kh√¥ng h·ª£p l·ªá!");
        }
      }

      // 5. X·ª≠ l√Ω Chuy·ªÉn kho·∫£n -> Ticket
      function handleTransfer() {
        const amount = document.getElementById("input-amount").value;
        const content = document.getElementById("input-content").value;
        
        if (!amount || parseInt(amount) <= 0) {
            alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn!"); return;
        }

        showLoading("ƒêang x·ª≠ l√Ω giao d·ªãch...", 2000, () => {
            document.getElementById("result-card").style.display = "none";
            
            // Generate Data cho Ticket
            const now = new Date();
            // ƒê·ªãnh d·∫°ng th·ªùi gian thanh to√°n
            const timeString = now.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'}) + " " + now.toLocaleDateString('vi-VN');
            
            // M√£ giao d·ªãch ·∫£o
            const transId = "FT" + Math.floor(Math.random() * 10000000000);

            // Fill Ticket
            document.getElementById("ticket-time").innerText = "Th·ªùi gian thanh to√°n: " + timeString;
            document.getElementById("ticket-trans-id").innerText = transId;
            document.getElementById("ticket-amount").innerText = parseInt(amount).toLocaleString('vi-VN') + " VND";
            
            // Quan tr·ªçng: T√™n ng∆∞·ªùi chuy·ªÉn l·∫•y t·ª´ bi·∫øn senderName (Input ban ƒë·∫ßu)
            document.getElementById("ticket-sender").innerText = senderName; 
            
            document.getElementById("ticket-receiver").innerText = document.getElementById("res-name").innerText;
            document.getElementById("ticket-bank").innerText = document.getElementById("res-bank").innerText;
            document.getElementById("ticket-acc").innerText = document.getElementById("res-acc").innerText;
            document.getElementById("ticket-content").innerText = content || "Kh√¥ng c√≥ n·ªôi dung";

            document.getElementById("ticket-card").style.display = "block";
        });
      }

      function shareTicket() {
          // Gi·∫£ l·∫≠p chia s·∫ª
          if (navigator.share) {
              navigator.share({
                  title: 'Bi√™n lai chuy·ªÉn ti·ªÅn',
                  text: `Chuy·ªÉn kho·∫£n th√†nh c√¥ng ${document.getElementById("ticket-amount").innerText} t·ªõi ${document.getElementById("ticket-receiver").innerText}`,
                  url: window.location.href
              }).catch(console.error);
          } else {
              alert("ƒê√£ sao ch√©p ·∫£nh bi√™n lai v√†o b·ªô nh·ªõ t·∫°m! (Gi·∫£ l·∫≠p)");
          }
      }

      function formatMoneyDisplay() {
          const val = document.getElementById("input-amount").value;
          document.getElementById("money-text").innerText = val ? parseInt(val).toLocaleString('vi-VN') + " VND" : "0 VND";
      }

      function onScanFailure(error) {}

      function startCamera() {
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, onScanFailure)
        .catch(err => document.getElementById("status-text").innerText = "L·ªói Camera: " + err);
      }

      function resetScanner() { location.reload(); }
    </script>
  </body>
</html>