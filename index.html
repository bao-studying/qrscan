<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üáªüá≥ VietQR Scanner Pro</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
      :root {
        --primary: #0056b3;
        --bg: #f0f2f5;
        --card-bg: #ffffff;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      h1 { color: var(--primary); margin-bottom: 10px; font-size: 1.5rem; }
      
      /* Camera Frame */
      #reader {
        width: 100%;
        max-width: 400px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: #000;
        margin-bottom: 20px;
      }

      /* Result Card */
      #result-card {
        width: 100%;
        max-width: 400px;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none; /* ·∫®n khi ch∆∞a qu√©t */
        box-sizing: border-box;
      }

      .info-row {
        margin-bottom: 12px;
        border-bottom: 1px dashed #eee;
        padding-bottom: 8px;
      }
      .info-row:last-child { border-bottom: none; }
      
      .label {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 4px;
        display: block;
      }
      .value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        word-break: break-all;
      }
      .highlight { color: var(--primary); font-size: 1.2rem; }
      
      .btn-copy {
        background: #eee;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        float: right;
      }
      
      .status {
        margin-top: 10px;
        font-style: italic;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>üáªüá≥ Qu√©t VietQR</h1>
    
    <div id="reader"></div>
    <div class="status" id="status-text">ƒêang b·∫≠t camera...</div>

    <div id="result-card">
      <h3 style="margin-top:0; text-align:center; color: #0056b3;">Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
      
      <div class="info-row">
        <span class="label">Ng√¢n h√†ng:</span>
        <span class="value" id="res-bank">...</span>
      </div>

      <div class="info-row">
        <span class="label">S·ªë t√†i kho·∫£n: <button class="btn-copy" onclick="copyText('res-acc')">Copy</button></span>
        <span class="value highlight" id="res-acc">...</span>
      </div>

      <div class="info-row">
        <span class="label">Ch·ªß t√†i kho·∫£n (N·∫øu c√≥):</span>
        <span class="value" id="res-name">...</span>
      </div>

      <div class="info-row">
        <span class="label">S·ªë ti·ªÅn:</span>
        <span class="value" id="res-amount">0 VND</span>
      </div>

      <div class="info-row">
        <span class="label">N·ªôi dung:</span>
        <span class="value" id="res-content">...</span>
      </div>
      
      <div style="margin-top:15px; text-align:center;">
        <button onclick="resetScanner()" style="padding:10px 20px; background:var(--primary); color:white; border:none; border-radius:6px; cursor:pointer;">Qu√©t m√£ kh√°c</button>
      </div>
    </div>

    <script>
      // üè¶ DANH S√ÅCH M√É BIN NG√ÇN H√ÄNG (C·∫≠p nh·∫≠t ƒë·∫ßy ƒë·ªß)
      const BANK_BIN = {
        "970436": "Vietcombank (VCB)",
        "970415": "VietinBank (CTG)",
        "970418": "BIDV",
        "970405": "Agribank",
        "970448": "OCB",
        "970422": "MB Bank (Qu√¢n ƒê·ªôi)",
        "970407": "Techcombank (TCB)",
        "970416": "ACB",
        "970432": "VPBank",
        "970423": "TPBank",
        "970403": "Sacombank",
        "970437": "HDBank",
        "970454": "VietCapital (B·∫£n Vi·ªát)",
        "970429": "SCB",
        "970441": "VIB",
        "970443": "SHB",
        "970409": "Bac A Bank",
        "970412": "PVcomBank",
        "970430": "PGBank",
        "970428": "Nam A Bank",
        "970414": "OceanBank",
        "970449": "LienVietPostBank",
        "970425": "ABBank",
        "970400": "SaigonBank",
        "970452": "KienLongBank",
        "970446": "Co-op Bank",
        "970458": "United Overseas Bank (UOB)",
        "970410": "Standard Chartered",
        "970424": "Shinhan Bank",
        "970431": "Eximbank",
        "970438": "BaoViet Bank",
        "970440": "SeABank",
        "970427": "VietABank",
        "970419": "NCB",
        "970433": "VietBank"
      };

      let html5QrcodeScanner = null;

      // üõ† H√ÄM GI·∫¢I M√É TLV (Tag-Length-Value)
      function parseTLV(str) {
        const result = {};
        let i = 0;
        while (i < str.length) {
          const id = str.substr(i, 2); // 2 k√Ω t·ª± ƒë·∫ßu l√† ID
          const len = parseInt(str.substr(i + 2, 2)); // 2 k√Ω t·ª± ti·∫øp l√† ƒë·ªô d√†i
          const val = str.substr(i + 4, len); // Gi√° tr·ªã
          result[id] = val;
          i += 4 + len;
        }
        return result;
      }

      // üß† TRUNG T√ÇM X·ª¨ L√ù VIETQR
      function processVietQR(qrContent) {
        try {
          // B∆∞·ªõc 1: Ph√¢n t√≠ch t·∫ßng 1
          const root = parseTLV(qrContent);

          // Ki·ªÉm tra xem c√≥ ph·∫£i VietQR kh√¥ng (D·ª±a v√†o GUID A000000727 trong Tag 38)
          // Tag 38 ch·ª©a th√¥ng tin ng∆∞·ªùi th·ª• h∆∞·ªüng
          if (!root["38"]) return null;

          // B∆∞·ªõc 2: Ph√¢n t√≠ch t·∫ßng 2 (B√™n trong Tag 38)
          const tag38Data = parseTLV(root["38"]);
          
          // Ki·ªÉm tra GUID NAPAS: Tag 00 ph·∫£i l√† A000000727
          if (tag38Data["00"] !== "A000000727") return null;

          // B∆∞·ªõc 3: Ph√¢n t√≠ch t·∫ßng 3 (B√™n trong Tag 01 c·ªßa Tag 38)
          // ƒê√¢y l√† n∆°i ch·ª©a BIN v√† S·ªë t√†i kho·∫£n
          const serviceData = parseTLV(tag38Data["01"]);

          const bankBin = serviceData["00"]; // Tag 00: M√£ BIN ng√¢n h√†ng
          const accountNo = serviceData["01"]; // Tag 01: S·ªë t√†i kho·∫£n

          // C√°c th√¥ng tin b·ªï sung ·ªü t·∫ßng 1
          const amount = root["54"] || "0"; // Tag 54: S·ªë ti·ªÅn (n·∫øu c√≥)
          const content = root["62"] ? parseTLV(root["62"])["08"] : ""; // Tag 62 -> 08: N·ªôi dung
          // L∆∞u √Ω: Tag 59 (T√™n ch·ªß TK) c√≥ th·ªÉ b·ªã ·∫©n ·ªü QR ƒë·ªông, nh∆∞ng QR tƒ©nh th∆∞·ªùng c√≥
          const accName = root["59"] || "Kh√¥ng r√µ (QR ƒê·ªông)"; 

          return {
            bankName: BANK_BIN[bankBin] || `Ng√¢n h√†ng l·∫° (BIN: ${bankBin})`,
            accountNo: accountNo,
            amount: amount,
            content: content,
            accName: accName
          };

        } catch (e) {
          console.error("L·ªói ph√¢n t√≠ch:", e);
          return null;
        }
      }

      // üì∑ X·ª¨ L√ù KHI QU√âT TH√ÄNH C√îNG
      function onScanSuccess(decodedText) {
        console.log(`M√£ g·ªëc: ${decodedText}`);

        const qrInfo = processVietQR(decodedText);

        if (qrInfo) {
          // D·ª´ng camera
          if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById("reader").style.display = "none";
                document.getElementById("status-text").style.display = "none";
            });
          }

          // Hi·ªÉn th·ªã k·∫øt qu·∫£
          document.getElementById("result-card").style.display = "block";
          document.getElementById("res-bank").textContent = qrInfo.bankName;
          document.getElementById("res-acc").textContent = qrInfo.accountNo;
          document.getElementById("res-name").textContent = qrInfo.accName;
          
          // Format ti·ªÅn t·ªá
          const money = parseInt(qrInfo.amount).toLocaleString('vi-VN');
          document.getElementById("res-amount").textContent = money !== "0" ? money + " VND" : "T√πy ch·ªçn nh·∫≠p";
          
          document.getElementById("res-content").textContent = qrInfo.content || "Kh√¥ng c√≥ n·ªôi dung";
        } else {
           // N·∫øu kh√¥ng ph·∫£i VietQR (v√≠ d·ª• qu√©t link web)
           alert("ƒê√¢y kh√¥ng ph·∫£i m√£ QR Ng√¢n h√†ng (VietQR)!\nN·ªôi dung: " + decodedText);
        }
      }

      function onScanFailure(error) {
        // Kh√¥ng l√†m g√¨ ƒë·ªÉ tr√°nh spam log
      }

      // Kh·ªüi ƒë·ªông Camera
      function startCamera() {
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
          { facingMode: "environment" }, 
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        ).catch(err => {
            document.getElementById("status-text").innerText = "L·ªói: Kh√¥ng th·ªÉ m·ªü camera. H√£y c·∫•p quy·ªÅn ho·∫∑c d√πng HTTPS.";
        });
      }

      // Reset ƒë·ªÉ qu√©t l·∫°i
      function resetScanner() {
        location.reload(); 
      }

      // Ti·ªán √≠ch copy
      function copyText(id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text);
        alert("ƒê√£ sao ch√©p: " + text);
      }

      // Ch·∫°y ngay khi load trang
      startCamera();

    </script>
  </body>
</html>