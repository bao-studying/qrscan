<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üáªüá≥ VietQR Pro Payment</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
      :root {
        --primary: #0056b3;
        --success: #28a745;
        --bg: #f0f2f5;
        --card-bg: #ffffff;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }
      h1 { color: var(--primary); margin-bottom: 10px; font-size: 1.5rem; }
      
      /* Camera Frame */
      #reader {
        width: 100%;
        max-width: 400px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        background: #000;
        margin-bottom: 20px;
        display: none; /* ·∫®n m·∫∑c ƒë·ªãnh ch·ªù nh·∫≠p t√™n */
      }

      /* Container chung cho c√°c Card */
      .card {
        width: 100%;
        max-width: 400px;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        box-sizing: border-box;
        margin-bottom: 20px;
      }

      /* 1. Modal Nh·∫≠p t√™n ban ƒë·∫ßu */
      #setup-modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .modal-content {
        background: white;
        padding: 25px;
        border-radius: 12px;
        width: 85%;
        max-width: 350px;
        text-align: center;
      }
      .custom-input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
      }

      /* 2. Form Chuy·ªÉn kho·∫£n (3 Blocks) */
      #result-card { display: none; }
      
      .block {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #eee;
      }
      .block-title {
        font-size: 0.8rem;
        color: #666;
        margin-bottom: 8px;
        text-transform: uppercase;
        font-weight: bold;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.95rem;
      }
      .info-val { font-weight: 600; color: #333; text-align: right; word-break: break-all;}
      .highlight { color: var(--primary); }

      .money-input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary);
        border-bottom: 2px solid #ddd;
        padding: 5px 0;
        outline: none;
      }
      .money-input:focus { border-bottom-color: var(--primary); }

      .content-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-family: inherit;
        box-sizing: border-box;
      }

      .btn-primary {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn-primary:active { background: #004494; }

      /* 3. Ticket Th√†nh c√¥ng */
      #ticket-card {
        display: none;
        background: #fff;
        border-top: 5px solid var(--success);
        position: relative;
      }
      #ticket-card::before {
        content: "";
        position: absolute;
        top: -5px; left: 0; right: 0; height: 5px; background: var(--success);
      }
      .success-icon {
        color: var(--success);
        font-size: 3rem;
        text-align: center;
        margin-bottom: 10px;
      }
      .ticket-amount {
        text-align: center;
        font-size: 1.8rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
      }
      .dashed-line {
        border-bottom: 2px dashed #eee;
        margin: 15px 0;
      }

      /* Loading Overlay */
      #loading-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.9);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      .spinner {
        width: 50px; height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      .status { margin-top: 10px; font-style: italic; color: #666; text-align: center;}
    </style>
  </head>
  <body>
    <h1>üáªüá≥ VietQR Pay</h1>
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-weight:600; color:#555;">ƒêang x·ª≠ l√Ω...</div>
    </div>

    <div id="setup-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary)">Thi·∫øt l·∫≠p</h3>
            <p style="font-size:0.9rem; color:#666; margin-bottom:5px;">Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n (Ng∆∞·ªùi chuy·ªÉn):</p>
            <input type="text" id="sender-name-input" class="custom-input" placeholder="V√≠ d·ª•: NGUYEN VAN A" autocomplete="off">
            <button class="btn-primary" onclick="confirmSetup()">B·∫Øt ƒë·∫ßu qu√©t</button>
        </div>
    </div>

    <div id="reader"></div>
    <div class="status" id="status-text" style="display:none;">ƒêang b·∫≠t camera...</div>

    <div id="result-card" class="card">
      <h3 style="margin-top:0; text-align:center; color: var(--primary); margin-bottom: 20px;">Th√¥ng tin chuy·ªÉn kho·∫£n</h3>
      
      <div class="block">
          <div class="block-title">T√†i kho·∫£n th·ª• h∆∞·ªüng</div>
          <div class="info-row">
              <span>Ng√¢n h√†ng:</span>
              <span class="info-val" id="res-bank">...</span>
          </div>
          <div class="info-row">
              <span>S·ªë t√†i kho·∫£n:</span>
              <span class="info-val highlight" id="res-acc">...</span>
          </div>
          <div class="info-row">
              <span>Ch·ªß t√†i kho·∫£n:</span>
              <span class="info-val" id="res-name">...</span>
          </div>
      </div>

      <div class="block">
          <div class="block-title">S·ªë ti·ªÅn giao d·ªãch</div>
          <input type="number" id="input-amount" class="money-input" placeholder="0" oninput="formatMoneyDisplay()">
          <div style="text-align:right; font-size:0.8rem; color:#999; margin-top:5px;" id="money-text">0 VND</div>
      </div>

      <div class="block">
          <div class="block-title">N·ªôi dung chuy·ªÉn ti·ªÅn</div>
          <textarea id="input-content" class="content-input" rows="3" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
      </div>
      
      <button class="btn-primary" onclick="handleTransfer()">Chuy·ªÉn kho·∫£n ngay</button>
      <div style="text-align:center; margin-top:15px;">
        <a href="#" onclick="resetScanner()" style="color:#666; font-size:0.9rem; text-decoration:none;">H·ªßy & Qu√©t l·∫°i</a>
      </div>
    </div>

    <div id="ticket-card" class="card">
        <div class="success-icon">‚úì</div>
        <div style="text-align:center; font-weight:bold; color:var(--success); margin-bottom:5px;">GIAO D·ªäCH TH√ÄNH C√îNG</div>
        <div style="text-align:center; color:#999; font-size:0.85rem; margin-bottom:15px;" id="ticket-time">...</div>
        
        <div class="ticket-amount" id="ticket-amount">0 VND</div>
        
        <div class="dashed-line"></div>
        
        <div class="info-row">
            <span style="color:#666">Ng∆∞·ªùi chuy·ªÉn:</span>
            <span class="info-val" id="ticket-sender">...</span>
        </div>
        <div class="dashed-line"></div>
        
        <div class="info-row">
            <span style="color:#666">Ng∆∞·ªùi nh·∫≠n:</span>
            <span class="info-val" id="ticket-receiver">...</span>
        </div>
        <div class="info-row">
            <span style="color:#666">Ng√¢n h√†ng:</span>
            <span class="info-val" id="ticket-bank">...</span>
        </div>
        <div class="info-row">
            <span style="color:#666">S·ªë t√†i kho·∫£n:</span>
            <span class="info-val" id="ticket-acc">...</span>
        </div>
        
        <div class="dashed-line"></div>
        
        <div style="font-size:0.85rem; color:#666; margin-bottom:5px;">N·ªôi dung:</div>
        <div style="background:#f5f5f5; padding:10px; border-radius:6px; color:#333;" id="ticket-content">...</div>

        <button class="btn-primary" style="margin-top:25px; background:#6c757d;" onclick="resetScanner()">Th·ª±c hi·ªán giao d·ªãch m·ªõi</button>
    </div>

    <script>
      // üè¶ DANH S√ÅCH M√É BIN NG√ÇN H√ÄNG (GI·ªÆ NGUY√äN)
      const BANK_BIN = {
        "970436": "Vietcombank (VCB)", "970415": "VietinBank (CTG)", "970418": "BIDV", "970405": "Agribank",
        "970448": "OCB", "970422": "MB Bank (Qu√¢n ƒê·ªôi)", "970407": "Techcombank (TCB)", "970416": "ACB",
        "970432": "VPBank", "970423": "TPBank", "970403": "Sacombank", "970437": "HDBank",
        "970454": "VietCapital (B·∫£n Vi·ªát)", "970429": "SCB", "970441": "VIB", "970443": "SHB",
        "970409": "Bac A Bank", "970412": "PVcomBank", "970430": "PGBank", "970428": "Nam A Bank",
        "970414": "OceanBank", "970449": "LienVietPostBank", "970425": "ABBank", "970400": "SaigonBank",
        "970452": "KienLongBank", "970446": "Co-op Bank", "970458": "United Overseas Bank (UOB)",
        "970410": "Standard Chartered", "970424": "Shinhan Bank", "970431": "Eximbank", "970438": "BaoViet Bank",
        "970440": "SeABank", "970427": "VietABank", "970419": "NCB", "970433": "VietBank",
        "970457": "Woori Bank", "970468": "SeABank"
      };

      let html5QrcodeScanner = null;
      let senderName = "B·∫°n"; // T√™n m·∫∑c ƒë·ªãnh

      // üõ† H√ÄM GI·∫¢I M√É TLV (Tag-Length-Value) - GI·ªÆ NGUY√äN
      function parseTLV(str) {
        const result = {};
        let i = 0;
        while (i < str.length) {
          const id = str.substr(i, 2);
          const len = parseInt(str.substr(i + 2, 2));
          const val = str.substr(i + 4, len);
          result[id] = val;
          i += 4 + len;
        }
        return result;
      }

      // üß† TRUNG T√ÇM X·ª¨ L√ù VIETQR - GI·ªÆ NGUY√äN
      function processVietQR(qrContent) {
        try {
          const root = parseTLV(qrContent);
          if (!root["38"]) return null;
          const tag38Data = parseTLV(root["38"]);
          if (tag38Data["00"] !== "A000000727") return null;
          const serviceData = parseTLV(tag38Data["01"]);
          const bankBin = serviceData["00"]; 
          const accountNo = serviceData["01"]; 
          const amount = root["54"] || "";
          const content = root["62"] ? parseTLV(root["62"])["08"] : ""; 
          const accName = root["59"] || "Kh√¥ng x√°c ƒë·ªãnh"; 

          return {
            bankName: BANK_BIN[bankBin] || `Ng√¢n h√†ng l·∫° (${bankBin})`,
            accountNo: accountNo,
            amount: amount,
            content: content,
            accName: accName
          };
        } catch (e) {
          console.error("L·ªói ph√¢n t√≠ch:", e);
          return null;
        }
      }

      // --- LOGIC M·ªöI B·∫ÆT ƒê·∫¶U T·ª™ ƒê√ÇY ---

      // 1. X√°c nh·∫≠n t√™n ng∆∞·ªùi chuy·ªÉn, ·∫©n modal, b·∫≠t camera
      function confirmSetup() {
        const inputName = document.getElementById("sender-name-input").value;
        if(inputName.trim() !== "") {
            senderName = inputName.toUpperCase();
        }
        document.getElementById("setup-modal").style.display = "none";
        document.getElementById("reader").style.display = "block";
        document.getElementById("status-text").style.display = "block";
        startCamera();
      }

      // 2. Hi·ªáu ·ª©ng Loading
      function showLoading(text, duration, callback) {
          const overlay = document.getElementById("loading-overlay");
          const txt = document.getElementById("loading-text");
          txt.innerText = text;
          overlay.style.display = "flex";
          
          setTimeout(() => {
              overlay.style.display = "none";
              if(callback) callback();
          }, duration);
      }

      // 3. X·ª≠ l√Ω khi qu√©t th√†nh c√¥ng
      function onScanSuccess(decodedText) {
        const qrInfo = processVietQR(decodedText);
        if (qrInfo) {
          // D·ª´ng camera
          if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById("reader").style.display = "none";
                document.getElementById("status-text").style.display = "none";
            });
          }

          // Loading ·∫£o 2 gi√¢y -> Hi·ªán form
          showLoading("ƒêang truy xu·∫•t th√¥ng tin...", 2000, () => {
              // ƒêi·ªÅn d·ªØ li·ªáu v√†o Form (Result Card)
              document.getElementById("res-bank").textContent = qrInfo.bankName;
              document.getElementById("res-acc").textContent = qrInfo.accountNo;
              document.getElementById("res-name").textContent = qrInfo.accName;
              
              // ƒêi·ªÅn ti·ªÅn v√† n·ªôi dung n·∫øu c√≥ trong QR
              const amountInput = document.getElementById("input-amount");
              amountInput.value = qrInfo.amount;
              formatMoneyDisplay(); // Update text hi·ªÉn th·ªã

              const contentInput = document.getElementById("input-content");
              contentInput.value = qrInfo.content;

              // Hi·ªán Form
              document.getElementById("result-card").style.display = "block";
          });

        } else {
           alert("M√£ QR kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ph·∫£i VietQR!");
        }
      }

      // 4. X·ª≠ l√Ω s·ª± ki·ªán "Chuy·ªÉn kho·∫£n"
      function handleTransfer() {
        // L·∫•y d·ªØ li·ªáu t·ª´ form
        const amount = document.getElementById("input-amount").value;
        const content = document.getElementById("input-content").value;
        
        if (!amount || parseInt(amount) <= 0) {
            alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!");
            return;
        }

        // Loading ·∫£o 2 gi√¢y -> Hi·ªán Ticket
        showLoading("ƒêang th·ª±c hi·ªán giao d·ªãch...", 2000, () => {
            // ·∫®n form
            document.getElementById("result-card").style.display = "none";
            
            // ƒêi·ªÅn th√¥ng tin v√†o Ticket
            const now = new Date();
            document.getElementById("ticket-time").innerText = now.toLocaleString('vi-VN');
            document.getElementById("ticket-amount").innerText = parseInt(amount).toLocaleString('vi-VN') + " VND";
            
            document.getElementById("ticket-sender").innerText = senderName;
            document.getElementById("ticket-receiver").innerText = document.getElementById("res-name").innerText;
            document.getElementById("ticket-bank").innerText = document.getElementById("res-bank").innerText;
            document.getElementById("ticket-acc").innerText = document.getElementById("res-acc").innerText;
            document.getElementById("ticket-content").innerText = content || "Kh√¥ng c√≥ n·ªôi dung";

            // Hi·ªán Ticket
            document.getElementById("ticket-card").style.display = "block";
        });
      }

      // Format hi·ªÉn th·ªã ti·ªÅn t·ªá b√™n d∆∞·ªõi input
      function formatMoneyDisplay() {
          const val = document.getElementById("input-amount").value;
          const display = document.getElementById("money-text");
          if(val) {
              display.innerText = parseInt(val).toLocaleString('vi-VN') + " VND";
          } else {
              display.innerText = "0 VND";
          }
      }

      function onScanFailure(error) {
        // Ignored
      }

      function startCamera() {
        html5QrcodeScanner = new Html5Qrcode("reader");
        html5QrcodeScanner.start(
          { facingMode: "environment" }, 
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        ).catch(err => {
            document.getElementById("status-text").innerText = "L·ªói Camera: " + err;
        });
      }

      function resetScanner() {
        location.reload(); 
      }

    </script>
  </body>
</html>